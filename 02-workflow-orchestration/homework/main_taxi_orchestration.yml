id: main_taxi_orchestration
namespace: zoomcamp

tasks:
  - id: loop_years
    type: io.kestra.plugin.core.flow.ForEach
    values: ["2020", "2021"]
    tasks:
      - id: loop_months
        type: io.kestra.plugin.core.flow.ForEach
        values: ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"]
        tasks:
          - id: loop_taxi_types
            type: io.kestra.plugin.core.flow.ForEach
            values: ["yellow", "green"]
            tasks:
              - id: check_2021_limit
                type: io.kestra.core.tasks.flows.If
                # Skip if year is 2021 and month is August (08) or later
                condition: "{{taskrun.parents[2].value == '2021' and taskrun.parents[1].value in ['08', '09', '10', '11', '12']}}"
                then:
                  - id: skip_execution
                    type: io.kestra.core.tasks.debugs.Return
                    format: "Skipping {{taskrun.parents[1].value}}-{{taskrun.parents[2].value}} as data does not exist"
                else:
                  - id: run_subflow
                    type: io.kestra.core.tasks.flows.Subflow
                    namespace: company.team
                    flowId: extract_taxi_data
                    inputs:
                      taxi: "{{taskrun.value}}"
                      year: "{{taskrun.parents[2].value}}"
                      month: "{{taskrun.parents[1].value}}"
                    wait: true
